CREATE TABLE sox.innehav
	(KundforetagID		int,
	 KundID				int,
	 KapitalID			varchar(40),
	 Innehav			varchar(50),
	 Premieandel		decimal);

INSERT INTO sox.innehav
	SELECT
	k.KundforetagID,
	k.KundID,
	k.KapitalID,
	i.Namn,
	i.Premieandel
	FROM sox.kapital k
	JOIN dw.innehav i ON k.KapitalID = i.KapitalID
	WHERE i.Namn != 'Pågående affär eller öresavrundning'

CREATE INDEX idx_kundforetagid ON sox.innehav (KundforetagID)
CREATE INDEX idx_kundid ON sox.innehav (KundID)

SELECT * FROM
(SELECT
ROW_NUMBER() OVER(PARTITION BY i.KundforetagID ORDER BY i.KundforetagID ASC) AS 'RowNbr',
i.KundforetagID,
i.Innehav,
COUNT(*) AS 'Antal'
FROM sox.innehav i
GROUP BY i.KundforetagID, i.Innehav) a
ORDER BY a.KundforetagID, a.Antal DESC


DROP TABLE sox.innehav

====================================================================================================

-- 2019-01-14

CREATE VIEW [dw].[vy_ag_Innehav]
  (KoncernID,
   KundforetagID,
   Innehav,
   Antal) AS
SELECT
o.KoncernID AS 'KoncernID',
i.KundforetagID,
i.Innehav,
COUNT(*) AS 'Antal'
FROM sox.innehav i
JOIN sox.kundforetag kf ON i.KundforetagID = kf.KundforetagID
JOIN sox.orgnr o ON kf.Orgnr = o.Orgnr
GROUP BY o.KoncernID, i.KundforetagID, i.Innehav


UNION ALL

SELECT
o.EgetKoncernID AS 'KoncernID',
i.KundforetagID,
i.Innehav,
COUNT(*) AS 'Antal'
FROM sox.innehav i
JOIN sox.kundforetag kf ON i.KundforetagID = kf.KundforetagID
JOIN sox.orgnr o ON kf.Orgnr = o.Orgnr
WHERE o.EgetKoncernID IS NOT NULL
GROUP BY o.EgetKoncernID, i.KundforetagID, i.Innehav
ORDER BY i.KundforetagID, Antal DESC

SELECT * FROM [dw].[vy_ag_Innehav]
ORDER BY KundforetagID, Antal DESC
